<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redirecting...</title>
<script>

        function getQueryParam(param) {
            console.log('🌐 HTML - Getting query param:', param);
            console.log('🌐 HTML - Full URL:', window.location.href);
            console.log('🌐 HTML - Search part:', window.location.search);
            
            // For secure parameter, we need to manually parse to preserve + characters
            if (param === 'secure') {
                console.log('🌐 HTML - SECURE PARAMETER - Using manual parsing to preserve + characters');
                
                const search = window.location.search.substring(1); // Remove the '?'
                const pairs = search.split('&');
                
                for (let pair of pairs) {
                    // Use indexOf to find the first '=' to properly handle values that contain '='
                    const equalIndex = pair.indexOf('=');
                    if (equalIndex === -1) continue;
                    
                    const key = pair.substring(0, equalIndex);
                    const value = pair.substring(equalIndex + 1); // This preserves any '=' in the value
                    
                    if (key === 'secure') {
                        // Manually decode, but preserve + as actual + characters
                        let decodedValue = decodeURIComponent(value);
                        
                        console.log('🌐 HTML - Raw secure value from URL:', '"' + value + '"');
                        console.log('🌐 HTML - Decoded secure value:', '"' + decodedValue + '"');
                        console.log('🌐 HTML - Secure length:', decodedValue.length);
                        console.log('🌐 HTML - Secure ends with +:', decodedValue.endsWith('+'));
                        console.log('🌐 HTML - Secure last 5 chars:', '"' + decodedValue.slice(-5) + '"');
                        
                        return decodedValue;
                    }
                }
                
                console.log('🌐 HTML - Secure not found in URL');
                return "";
            } else {
                // For non-secure parameters, use normal URLSearchParams
                const urlParams = new URLSearchParams(window.location.search);
                const value = urlParams.get(param) || "";
                
                console.log('🌐 HTML - Retrieved value for', param + ':', '"' + value + '"');
                console.log('🌐 HTML - Value length:', value.length);
                
                return value;
            }
        }
 
        function detectDevice() {

            var userAgent = navigator.userAgent || navigator.vendor || window.opera;

            return {

                isAndroid: /android/i.test(userAgent),

                isIOS: /iPad|iPhone|iPod/.test(userAgent),

            };

        }
 
        function openFallback(isIOS, isAndroid) {

            if (isIOS) {

                window.location.href = "https://apps.apple.com/us/app/claimtoolkit/id6742053471";

            } else if (isAndroid) {

                window.location.href = "intent://details?id=com.claimtoolkit#Intent;scheme=market;package=com.android.vending;end";

            }

        }
 
        function redirectToApp() {

            var investigatorId = getQueryParam("investigatorId");

            var companyId = getQueryParam("companyId");

            var secure = getQueryParam("secure");
 
            var appLink = "claimtoolkit://open?";

            var params = [];

            

            if (secure) {
                console.log('🌐 HTML - Processing secure for app link');
                console.log('🌐 HTML - Original secure:', '"' + secure + '"');
                console.log('🌐 HTML - Secure length:', secure.length);
                console.log('🌐 HTML - Secure ends with +:', secure.endsWith('+'));
                
                // The secure is already properly decoded from the URL
                // Don't encode it again - React Native Linking will handle URL encoding automatically
                // This prevents double-encoding which corrupts + and = characters
                params.push(`secure=${secure}`);

            } else {

                if (investigatorId) params.push(`investigatorId=${encodeURIComponent(investigatorId)}`);

                if (companyId) params.push(`companyId=${encodeURIComponent(companyId)}`);

            }

            

            appLink += params.join("&");

            console.log('🌐 HTML - Final app link:', '"' + appLink + '"');
 
            var { isAndroid, isIOS } = detectDevice();

            var isMobile = isAndroid || isIOS;
 
            if (!isMobile) {

                document.getElementById("message").textContent = "Please open this link on your mobile device (iOS or Android)";

                return;

            }
 
            var now = Date.now();

            var fallbackTriggered = false;
 
            function attemptFallback() {

                if (!fallbackTriggered && Date.now() - now < 200) {

                    fallbackTriggered = true;

                    openFallback(isIOS, isAndroid);

                }

            }
 
            if (isAndroid) {

                document.addEventListener("visibilitychange", function () {

                    if (document.hidden) fallbackTriggered = true;

                });

            }
 
            window.location.href = appLink;
 
            setTimeout(() => {

                if (isIOS) {

                    attemptFallback();

                } else if (isAndroid && !document.hidden) {

                    openFallback(isIOS, isAndroid);

                }

            }, isIOS ? 0 : 1500);

        }
</script>
</head>
<body onload="redirectToApp()">
<p id="message">Redirecting to ClaimToolkit...</p>
</body>
</html>
 