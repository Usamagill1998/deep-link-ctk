<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redirecting...</title>
<script>

        function getQueryParam(param) {
            console.log('ğŸŒ HTML - Getting query param:', param);
            console.log('ğŸŒ HTML - Full URL:', window.location.href);
            console.log('ğŸŒ HTML - Search part:', window.location.search);
            
            // For token parameter, we need to manually parse to preserve + characters
            if (param === 'token') {
                console.log('ğŸŒ HTML - TOKEN PARAMETER - Using manual parsing to preserve + characters');
                
                const search = window.location.search.substring(1); // Remove the '?'
                const pairs = search.split('&');
                
                for (let pair of pairs) {
                    const [key, value] = pair.split('=');
                    if (key === 'token') {
                        // Manually decode, but preserve + as actual + characters
                        let decodedValue = decodeURIComponent(value);
                        
                        console.log('ğŸŒ HTML - Raw token value from URL:', '"' + value + '"');
                        console.log('ğŸŒ HTML - Decoded token value:', '"' + decodedValue + '"');
                        console.log('ğŸŒ HTML - Token length:', decodedValue.length);
                        console.log('ğŸŒ HTML - Token ends with +:', decodedValue.endsWith('+'));
                        console.log('ğŸŒ HTML - Token last 5 chars:', '"' + decodedValue.slice(-5) + '"');
                        
                        return decodedValue;
                    }
                }
                
                console.log('ğŸŒ HTML - Token not found in URL');
                return "";
            } else {
                // For non-token parameters, use normal URLSearchParams
                const urlParams = new URLSearchParams(window.location.search);
                const value = urlParams.get(param) || "";
                
                console.log('ğŸŒ HTML - Retrieved value for', param + ':', '"' + value + '"');
                console.log('ğŸŒ HTML - Value length:', value.length);
                
                return value;
            }
        }
 
        function detectDevice() {

            var userAgent = navigator.userAgent || navigator.vendor || window.opera;

            return {

                isAndroid: /android/i.test(userAgent),

                isIOS: /iPad|iPhone|iPod/.test(userAgent),

            };

        }
 
        function openFallback(isIOS, isAndroid) {

            if (isIOS) {

                window.location.href = "https://apps.apple.com/us/app/claimtoolkit/id6742053471";

            } else if (isAndroid) {

                window.location.href = "intent://details?id=com.claimtoolkit#Intent;scheme=market;package=com.android.vending;end";

            }

        }
 
        function redirectToApp() {

            var investigatorId = getQueryParam("investigatorId");

            var companyId = getQueryParam("companyId");

            var token = getQueryParam("token");
 
            var appLink = "claimtoolkit://open?";

            var params = [];

            

            if (token) {
                console.log('ğŸŒ HTML - Processing token for app link');
                console.log('ğŸŒ HTML - Original token:', '"' + token + '"');
                console.log('ğŸŒ HTML - Token length:', token.length);
                console.log('ğŸŒ HTML - Token ends with +:', token.endsWith('+'));
                
                // The token is already properly decoded from the URL
                // Don't encode it again - React Native Linking will handle URL encoding automatically
                // This prevents double-encoding which corrupts + and = characters
                params.push(`token=${token}`);

            } else {

                if (investigatorId) params.push(`investigatorId=${encodeURIComponent(investigatorId)}`);

                if (companyId) params.push(`companyId=${encodeURIComponent(companyId)}`);

            }

            

            appLink += params.join("&");

            console.log('ğŸŒ HTML - Final app link:', '"' + appLink + '"');
 
            var { isAndroid, isIOS } = detectDevice();

            var isMobile = isAndroid || isIOS;
 
            if (!isMobile) {

                document.getElementById("message").textContent = "Please open this link on your mobile device (iOS or Android)";

                return;

            }
 
            var now = Date.now();

            var fallbackTriggered = false;
 
            function attemptFallback() {

                if (!fallbackTriggered && Date.now() - now < 200) {

                    fallbackTriggered = true;

                    openFallback(isIOS, isAndroid);

                }

            }
 
            if (isAndroid) {

                document.addEventListener("visibilitychange", function () {

                    if (document.hidden) fallbackTriggered = true;

                });

            }
 
            window.location.href = appLink;
 
            setTimeout(() => {

                if (isIOS) {

                    attemptFallback();

                } else if (isAndroid && !document.hidden) {

                    openFallback(isIOS, isAndroid);

                }

            }, isIOS ? 0 : 1500);

        }
</script>
</head>
<body onload="redirectToApp()">
<p id="message">Redirecting to ClaimToolkit...</p>
</body>
</html>
 